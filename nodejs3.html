<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node.js Backend Development - Chapter 3: Database Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4285f4',
                        secondary: '#34a853',
                        accent: '#ff9800'
                    }
                }
            }
        }

        // Text-to-Speech functionality
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isPlaying = false;

        function initTTS() {
            // Check if browser supports speech synthesis
            if (!('speechSynthesis' in window)) {
                console.warn('Speech synthesis not supported');
                return;
            }

            // Initialize speech controls
            const playBtn = document.getElementById('playTTS');
            const pauseBtn = document.getElementById('pauseTTS');
            const stopBtn = document.getElementById('stopTTS');
            const rateSelect = document.getElementById('ttsRate');
            const voiceSelect = document.getElementById('ttsVoice');

            // Populate voice options
            function populateVoices() {
                const voices = speechSynthesis.getVoices();
                voiceSelect.innerHTML = '';

                voices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
            }

            // Load voices when available
            if (speechSynthesis.getVoices().length > 0) {
                populateVoices();
            } else {
                speechSynthesis.onvoiceschanged = populateVoices;
            }

            // Play TTS
            playBtn.addEventListener('click', () => {
                if (isPlaying) {
                    speechSynthesis.resume();
                } else {
                    const text = document.body.innerText;
                    const utterance = new SpeechSynthesisUtterance(text);

                    // Set voice
                    const voices = speechSynthesis.getVoices();
                    const selectedVoice = voices[voiceSelect.value];
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }

                    // Set rate
                    utterance.rate = parseFloat(rateSelect.value);

                    // Event handlers
                    utterance.onstart = () => {
                        isPlaying = true;
                        playBtn.disabled = true;
                        pauseBtn.disabled = false;
                        stopBtn.disabled = false;
                    };

                    utterance.onend = () => {
                        isPlaying = false;
                        playBtn.disabled = false;
                        pauseBtn.disabled = true;
                        stopBtn.disabled = true;
                    };

                    utterance.onerror = () => {
                        isPlaying = false;
                        playBtn.disabled = false;
                        pauseBtn.disabled = true;
                        stopBtn.disabled = true;
                    };

                    currentUtterance = utterance;
                    speechSynthesis.speak(utterance);
                }
            });

            // Pause TTS
            pauseBtn.addEventListener('click', () => {
                if (speechSynthesis.speaking && !speechSynthesis.paused) {
                    speechSynthesis.pause();
                    playBtn.disabled = false;
                    pauseBtn.disabled = true;
                }
            });

            // Stop TTS
            stopBtn.addEventListener('click', () => {
                speechSynthesis.cancel();
                isPlaying = false;
                playBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
            });
        }

        // Chapter tracking functionality
        function initChapterTracking() {
            const chapterId = 'nodejs3';
            const progressKey = `chapter_${chapterId}_progress`;
            const completedKey = `chapter_${chapterId}_completed`;

            // Load saved progress
            const savedProgress = localStorage.getItem(progressKey);
            const isCompleted = localStorage.getItem(completedKey) === 'true';

            if (savedProgress) {
                const progress = JSON.parse(savedProgress);
                // Restore reading position or other progress indicators
                console.log('Loaded progress:', progress);
            }

            // Mark chapter as started
            if (!savedProgress) {
                const startTime = new Date().toISOString();
                localStorage.setItem(progressKey, JSON.stringify({
                    started: startTime,
                    lastRead: startTime
                }));
            }

            // Update progress on scroll
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const scrollTop = window.pageYOffset;
                    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
                    const scrollPercent = (scrollTop / docHeight) * 100;

                    const progress = {
                        scrollPercent: Math.round(scrollPercent),
                        lastRead: new Date().toISOString()
                    };

                    localStorage.setItem(progressKey, JSON.stringify(progress));

                    // Auto-mark as completed when 80% scrolled
                    if (scrollPercent >= 80 && !isCompleted) {
                        localStorage.setItem(completedKey, 'true');
                        showCompletionMessage();
                    }
                }, 1000);
            });

            // Manual completion button
            const completeBtn = document.getElementById('markComplete');
            if (completeBtn) {
                completeBtn.addEventListener('click', () => {
                    localStorage.setItem(completedKey, 'true');
                    completeBtn.disabled = true;
                    completeBtn.textContent = '‚úì Completed';
                    showCompletionMessage();
                });

                if (isCompleted) {
                    completeBtn.disabled = true;
                    completeBtn.textContent = '‚úì Completed';
                }
            }
        }

        function showCompletionMessage() {
            // Create completion message
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.innerHTML = 'üéâ Chapter completed! Progress saved.';
            document.body.appendChild(message);

            // Remove after 3 seconds
            setTimeout(() => {
                message.remove();
            }, 3000);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initTTS();
            initChapterTracking();
        });
    </script>
</head>
<body class="bg-gradient-to-br from-blue-400 via-purple-500 to-blue-600 min-h-screen text-gray-800">
    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-500 to-green-500 text-white py-12 px-8 text-center relative">
            <h1 class="text-4xl font-light mb-4">üóÑÔ∏è Node.js Backend Development</h1>
            <p class="text-xl opacity-90">Chapter 3: Database Integration</p>

            <!-- TTS Controls -->
            <div class="absolute top-4 right-4 bg-white bg-opacity-20 rounded-lg p-3 backdrop-blur-sm">
                <div class="flex items-center space-x-2 text-sm">
                    <span class="text-white">üîä</span>
                    <button id="playTTS" class="bg-white bg-opacity-30 hover:bg-opacity-50 text-white px-3 py-1 rounded text-xs transition-colors" title="Play">‚ñ∂Ô∏è</button>
                    <button id="pauseTTS" class="bg-white bg-opacity-30 hover:bg-opacity-50 text-white px-3 py-1 rounded text-xs transition-colors" disabled title="Pause">‚è∏Ô∏è</button>
                    <button id="stopTTS" class="bg-white bg-opacity-30 hover:bg-opacity-50 text-white px-3 py-1 rounded text-xs transition-colors" disabled title="Stop">‚èπÔ∏è</button>
                    <select id="ttsVoice" class="bg-white bg-opacity-30 text-white text-xs px-2 py-1 rounded" title="Voice"></select>
                    <select id="ttsRate" class="bg-white bg-opacity-30 text-white text-xs px-2 py-1 rounded" title="Speed">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
            </div>

            <!-- Chapter Progress -->
            <div class="absolute top-4 left-4 bg-white bg-opacity-20 rounded-lg p-3 backdrop-blur-sm">
                <button id="markComplete" class="bg-white bg-opacity-30 hover:bg-opacity-50 text-white px-4 py-2 rounded text-sm transition-colors">
                    Mark as Complete
                </button>
            </div>
        </header>

        <!-- Content -->
        <main class="px-8 py-12">
            <!-- Chapter Navigation -->
            <nav class="bg-gray-50 p-6 rounded-lg mb-8 border-l-4 border-blue-500">
                <h3 class="text-xl font-semibold text-blue-600 mb-4">üìö Chapter Navigation</h3>
                <div class="flex flex-wrap gap-3">
                    <a href="study-guide-progress.html" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">üìä Progress Dashboard</a>
                    <a href="nodejs1.html" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">üìñ Chapter 1: Fundamentals</a>
                    <a href="nodejs2.html" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">üìñ Chapter 2: Express.js</a>
                    <a href="nodejs3.html" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600 transition-colors">üìñ Current: Chapter 3</a>
                    <a href="nodejs4.html" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">üìñ Chapter 4: Auth & Security</a>
                    <a href="nodejs5.html" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">üìñ Chapter 5: API Development</a>
                </div>
            </nav>

            <!-- Database Integration Overview -->
            <section class="mb-12">
                <h2 class="text-2xl font-semibold text-blue-600 border-b-2 border-gray-200 pb-3 mb-6">üóÑÔ∏è Database Integration Overview</h2>
                <p class="text-gray-700 mb-6">Databases are essential for storing and retrieving data in web applications. Node.js supports both SQL and NoSQL databases, each with its own strengths and use cases.</p>

                <div class="overflow-x-auto">
                    <table class="w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left font-semibold text-gray-800">Aspect</th>
                                <th class="px-6 py-4 text-left font-semibold text-gray-800">SQL Databases</th>
                                <th class="px-6 py-4 text-left font-semibold text-gray-800">NoSQL Databases</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr class="hover:bg-blue-50">
                                <td class="px-6 py-4 font-medium">Structure</td>
                                <td class="px-6 py-4">Tables with fixed schema</td>
                                <td class="px-6 py-4">Flexible schema (documents, key-value, etc.)</td>
                            </tr>
                            <tr class="hover:bg-blue-50">
                                <td class="px-6 py-4 font-medium">Query Language</td>
                                <td class="px-6 py-4">SQL (Structured Query Language)</td>
                                <td class="px-6 py-4">Various query methods (JSON, etc.)</td>
                            </tr>
                            <tr class="hover:bg-blue-50">
                                <td class="px-6 py-4 font-medium">Scalability</td>
                                <td class="px-6 py-4">Vertical scaling</td>
                                <td class="px-6 py-4">Horizontal scaling</td>
                            </tr>
                            <tr class="hover:bg-blue-50">
                                <td class="px-6 py-4 font-medium">Use Cases</td>
                                <td class="px-6 py-4">Complex queries, transactions, structured data</td>
                                <td class="px-6 py-4">Big data, real-time apps, flexible schemas</td>
                            </tr>
                            <tr class="hover:bg-blue-50">
                                <td class="px-6 py-4 font-medium">Examples</td>
                                <td class="px-6 py-4">MySQL, PostgreSQL, SQLite</td>
                                <td class="px-6 py-4">MongoDB, Redis, Cassandra</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- PostgreSQL with Node.js -->
            <section class="mb-12">
                <h2 class="text-2xl font-semibold text-blue-600 border-b-2 border-gray-200 pb-3 mb-6">üêò PostgreSQL with Node.js</h2>
                <p class="text-gray-700 mb-6">PostgreSQL is a powerful, open-source relational database known for its robustness and advanced features.</p>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Installation and Setup</h3>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-6 mb-6">
                    <div class="bg-gray-200 px-4 py-2 rounded-t-lg font-semibold text-gray-700 mb-4">Installing PostgreSQL and Node.js Driver</div>
                    <pre class="text-sm overflow-x-auto"><code># Install PostgreSQL (Ubuntu/Debian)
sudo apt update
sudo apt install postgresql postgresql-contrib

# Install PostgreSQL (macOS with Homebrew)
brew install postgresql
brew services start postgresql

# Install Node.js PostgreSQL driver
npm install pg

# Optional: Install connection pool
npm install pg-pool</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Basic Connection</h3>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-6 mb-6">
                    <div class="bg-gray-200 px-4 py-2 rounded-t-lg font-semibold text-gray-700 mb-4">Basic PostgreSQL Connection</div>
                    <pre class="text-sm overflow-x-auto"><code>const { Client } = require('pg');

// Database configuration
const client = new Client({
    host: 'localhost',
    port: 5432,
    database: 'mydb',
    user: 'myuser',
    password: 'mypassword'
});

// Connect to database
async function connectDB() {
    try {
        await client.connect();
        console.log('Connected to PostgreSQL database');
    } catch (error) {
        console.error('Connection error:', error);
    }
}

connectDB();</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">CRUD Operations</h3>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-6 mb-6">
                    <div class="bg-gray-200 px-4 py-2 rounded-t-lg font-semibold text-gray-700 mb-4">PostgreSQL CRUD Operations</div>
                    <pre class="text-sm overflow-x-auto"><code>const { Client } = require('pg');

const client = new Client({
    connectionString: process.env.DATABASE_URL
});

async function runOperations() {
    try {
        await client.connect();

        // Create table
        await client.query(`
            CREATE TABLE IF NOT EXISTS users (
                id SERIAL PRIMARY KEY,
                name VARCHAR(100) NOT NULL,
                email VARCHAR(100) UNIQUE NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        `);

        // INSERT - Create
        const insertQuery = 'INSERT INTO users (name, email) VALUES ($1, $2) RETURNING *';
        const insertResult = await client.query(insertQuery, ['John Doe', 'john@example.com']);
        console.log('Inserted user:', insertResult.rows[0]);

        // SELECT - Read
        const selectQuery = 'SELECT * FROM users WHERE id = $1';
        const selectResult = await client.query(selectQuery, [1]);
        console.log('Selected user:', selectResult.rows[0]);

        // UPDATE - Update
        const updateQuery = 'UPDATE users SET name = $1 WHERE id = $2 RETURNING *';
        const updateResult = await client.query(updateQuery, ['Jane Doe', 1]);
        console.log('Updated user:', updateResult.rows[0]);

        // DELETE - Delete
        const deleteQuery = 'DELETE FROM users WHERE id = $1 RETURNING *';
        const deleteResult = await client.query(deleteQuery, [1]);
        console.log('Deleted user:', deleteResult.rows[0]);

    } catch (error) {
        console.error('Database operation error:', error);
    } finally {
        await client.end();
    }
}

runOperations();</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Connection Pooling</h3>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-6 mb-6">
                    <div class="bg-gray-200 px-4 py-2 rounded-t-lg font-semibold text-gray-700 mb-4">PostgreSQL Connection Pooling</div>
                    <pre class="text-sm overflow-x-auto"><code>const { Pool } = require('pg');

const pool = new Pool({
    host: 'localhost',
    port: 5432,
    database: 'mydb',
    user: 'myuser',
    password: 'mypassword',
    max: 20, // Maximum number of clients in the pool
    idleTimeoutMillis: 30000, // Close idle clients after 30 seconds
    connectionTimeoutMillis: 2000, // Return an error after 2 seconds if connection could not be established
});

// Use pool for queries
async function getUsers() {
    const client = await pool.connect();
    try {
        const result = await client.query('SELECT * FROM users');
        return result.rows;
    } finally {
        client.release(); // Release the client back to the pool
    }
}

// Clean up pool on application shutdown
process.on('SIGINT', () => {
    pool.end();
    console.log('Database pool closed');
    process.exit(0);
});

module.exports = pool;</code></pre>
                </div>
            </section>

            <!-- MongoDB with Node.js -->
            <section class="mb-12">
                <h2 class="text-2xl font-semibold text-blue-600 border-b-2 border-gray-200 pb-3 mb-6">üçÉ MongoDB with Node.js</h2>
                <p class="text-gray-700 mb-6">MongoDB is a popular NoSQL document database that stores data in flexible, JSON-like documents.</p>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Installation and Setup</h3>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-6 mb-6">
                    <div class="bg-gray-200 px-4 py-2 rounded-t-lg font-semibold text-gray-700 mb-4">Installing MongoDB and Node.js Driver</div>
                    <pre class="text-sm overflow-x-auto"><code># Install MongoDB Community Edition (Ubuntu/Debian)
wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
sudo apt update
sudo apt install mongodb-org
sudo systemctl start mongod

# Install MongoDB (macOS with Homebrew)
brew tap mongodb/brew
brew install mongodb-community
brew services start mongodb/brew/mongodb-community

# Install Node.js MongoDB driver
npm install mongodb

# Optional: Install Mongoose ODM
npm install mongoose</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Basic Connection with Native Driver</h3>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-6 mb-6">
                    <div class="bg-gray-200 px-4 py-2 rounded-t-lg font-semibold text-gray-700 mb-4">MongoDB Native Driver Connection</div>
                    <pre class="text-sm overflow-x-auto"><code>const { MongoClient } = require('mongodb');

// Connection URL
const url = 'mongodb://localhost:27017';
const client = new MongoClient(url);

// Database Name
const dbName = 'myapp';

async function connectDB() {
    try {
        await client.connect();
        console.log('Connected to MongoDB');

        const db = client.db(dbName);

        // Ping the database
        await db.admin().ping();
        console.log('Database connection verified');

        return db;
    } catch (error) {
        console.error('MongoDB connection error:', error);
        throw error;
    }
}

module.exports = { connectDB, client };</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">CRUD Operations with Native Driver</h3>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-6 mb-6">
                    <div class="bg-gray-200 px-4 py-2 rounded-t-lg font-semibold text-gray-700 mb-4">MongoDB CRUD Operations</div>
                    <pre class="text-sm overflow-x-auto"><code>const { MongoClient } = require('mongodb');

async function runOperations() {
    const client = new MongoClient('mongodb://localhost:27017');
    const dbName = 'myapp';

    try {
        await client.connect();
        const db = client.db(dbName);
        const collection = db.collection('users');

        // INSERT - Create
        const insertResult = await collection.insertOne({
            name: 'John Doe',
            email: 'john@example.com',
            age: 30,
            createdAt: new Date()
        });
        console.log('Inserted document:', insertResult.insertedId);

        // INSERT MANY
        const insertManyResult = await collection.insertMany([
            { name: 'Jane Smith', email: 'jane@example.com', age: 25 },
            { name: 'Bob Johnson', email: 'bob@example.com', age: 35 }
        ]);
        console.log('Inserted documents count:', insertManyResult.insertedCount);

        // FIND - Read
        const findResult = await collection.find({ age: { $gte: 25 } }).toArray();
        console.log('Found documents:', findResult);

        // FIND ONE
        const findOneResult = await collection.findOne({ email: 'john@example.com' });
        console.log('Found one document:', findOneResult);

        // UPDATE - Update
        const updateResult = await collection.updateOne(
            { email: 'john@example.com' },
            { $set: { age: 31 }, $currentDate: { lastModified: true } }
        );
        console.log('Updated documents count:', updateResult.modifiedCount);

        // UPDATE MANY
        const updateManyResult = await collection.updateMany(
            { age: { $lt: 30 } },
            { $set: { category: 'young' } }
        );
        console.log('Updated many documents count:', updateManyResult.modifiedCount);

        // DELETE - Delete
        const deleteResult = await collection.deleteOne({ email: 'john@example.com' });
        console.log('Deleted documents count:', deleteResult.deletedCount);

        // DELETE MANY
        const deleteManyResult = await collection.deleteMany({ category: 'young' });
        console.log('Deleted many documents count:', deleteManyResult.deletedCount);

    } catch (error) {
        console.error('Database operation error:', error);
    } finally {
        await client.close();
    }
}

runOperations();</code></pre>
                </div>
            </section>

            <!-- Mongoose ODM -->
            <section class="mb-12">
                <h2 class="text-2xl font-semibold text-blue-600 border-b-2 border-gray-200 pb-3 mb-6">üìö Mongoose ODM</h2>
                <p class="text-gray-700 mb-6">Mongoose is an Object Data Modeling (ODM) library for MongoDB and Node.js, providing a higher-level abstraction.</p>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Mongoose Setup and Schema</h3>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-6 mb-6">
                    <div class="bg-gray-200 px-4 py-2 rounded-t-lg font-semibold text-gray-700 mb-4">Mongoose Setup and Schema Definition</div>
                    <pre class="text-sm overflow-x-auto"><code>const mongoose = require('mongoose');

// Connect to MongoDB
async function connectDB() {
    try {
        await mongoose.connect('mongodb://localhost:27017/myapp', {
            useNewUrlParser: true,
            useUnifiedTopology: true
        });
        console.log('Connected to MongoDB with Mongoose');
    } catch (error) {
        console.error('Mongoose connection error:', error);
        process.exit(1);
    }
}

// User Schema
const userSchema = new mongoose.Schema({
    name: {
        type: String,
        required: [true, 'Name is required'],
        trim: true,
        maxlength: [50, 'Name cannot exceed 50 characters']
    },
    email: {
        type: String,
        required: [true, 'Email is required'],
        unique: true,
        lowercase: true,
        validate: {
            validator: function(email) {
                return /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(email);
            },
            message: 'Please enter a valid email'
        }
    },
    age: {
        type: Number,
        min: [0, 'Age cannot be negative'],
        max: [120, 'Age cannot exceed 120']
    },
    role: {
        type: String,
        enum: ['user', 'admin', 'moderator'],
        default: 'user'
    },
    isActive: {
        type: Boolean,
        default: true
    },
    createdAt: {
        type: Date,
        default: Date.now
    },
    updatedAt: {
        type: Date,
        default: Date.now
    }
});

// Pre-save middleware to update updatedAt
userSchema.pre('save', function(next) {
    this.updatedAt = Date.now();
    next();
});

// Instance method
userSchema.methods.getFullInfo = function() {
    return `${this.name} (${this.email}) - ${this.role}`;
};

// Static method
userSchema.statics.findByRole = function(role) {
    return this.find({ role: role });
};

// Virtual property
userSchema.virtual('ageInMonths').get(function() {
    return this.age * 12;
});

// Create User model
const User = mongoose.model('User', userSchema);

module.exports = { connectDB, User };</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Mongoose CRUD Operations</h3>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-6 mb-6">
                    <div class="bg-gray-200 px-4 py-2 rounded-t-lg font-semibold text-gray-700 mb-4">Mongoose CRUD Operations</div>
                    <pre class="text-sm overflow-x-auto"><code>const mongoose = require('mongoose');
const { User } = require('./models/User');

async function runOperations() {
    try {
        // CREATE - Create new user
        const newUser = new User({
            name: 'John Doe',
            email: 'john@example.com',
            age: 30,
            role: 'user'
        });

        const savedUser = await newUser.save();
        console.log('Created user:', savedUser);

        // CREATE MANY
        const users = await User.insertMany([
            { name: 'Jane Smith', email: 'jane@example.com', age: 25 },
            { name: 'Bob Johnson', email: 'bob@example.com', age: 35, role: 'admin' }
        ]);
        console.log('Created users:', users.length);

        // READ - Find all users
        const allUsers = await User.find();
        console.log('All users:', allUsers.length);

        // READ - Find with conditions
        const activeUsers = await User.find({ isActive: true });
        console.log('Active users:', activeUsers.length);

        // READ - Find one user
        const user = await User.findOne({ email: 'john@example.com' });
        console.log('Found user:', user ? user.getFullInfo() : 'Not found');

        // READ - Find by ID
        const userById = await User.findById(savedUser._id);
        console.log('User by ID:', userById.name);

        // READ - Find by role (static method)
        const admins = await User.findByRole('admin');
        console.log('Admin users:', admins.length);

        // UPDATE - Update one user
        const updatedUser = await User.findByIdAndUpdate(
            savedUser._id,
            { age: 31, updatedAt: Date.now() },
            { new: true, runValidators: true }
        );
        console.log('Updated user:', updatedUser.age);

        // UPDATE - Update many users
        const updateManyResult = await User.updateMany(
            { age: { $lt: 30 } },
            { role: 'junior' }
        );
        console.log('Updated users count:', updateManyResult.modifiedCount);

        // DELETE - Delete one user
        const deletedUser = await User.findByIdAndDelete(savedUser._id);
        console.log('Deleted user:', deletedUser.name);

        // DELETE - Delete many users
        const deleteManyResult = await User.deleteMany({ role: 'junior' });
        console.log('Deleted users count:', deleteManyResult.deletedCount);

    } catch (error) {
        console.error('Mongoose operation error:', error);
    }
}

runOperations();</code></pre>
                </div>
            </section>

            <!-- Database Integration with Express.js -->
            <section class="mb-12">
                <h2 class="text-2xl font-semibold text-blue-600 border-b-2 border-gray-200 pb-3 mb-6">üîó Database Integration with Express.js</h2>
                <p class="text-gray-700 mb-6">Integrating databases with Express.js applications for building complete web applications.</p>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Express.js API with PostgreSQL</h3>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-6 mb-6">
                    <div class="bg-gray-200 px-4 py-2 rounded-t-lg font-semibold text-gray-700 mb-4">Express.js API with PostgreSQL</div>
                    <pre class="text-sm overflow-x-auto"><code>const express = require('express');
const { Pool } = require('pg');
require('dotenv').config();

const app = express();
const port = process.env.PORT || 3000;

// Middleware
app.use(express.json());

// Database connection
const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    max: 20,
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 2000,
});

// Routes
app.get('/api/users', async (req, res) => {
    try {
        const { rows } = await pool.query('SELECT * FROM users ORDER BY created_at DESC');
        res.json({
            success: true,
            data: rows,
            count: rows.length
        });
    } catch (error) {
        console.error('Error fetching users:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to fetch users'
        });
    }
});

app.get('/api/users/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const { rows } = await pool.query('SELECT * FROM users WHERE id = $1', [id]);

        if (rows.length === 0) {
            return res.status(404).json({
                success: false,
                error: 'User not found'
            });
        }

        res.json({
            success: true,
            data: rows[0]
        });
    } catch (error) {
        console.error('Error fetching user:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to fetch user'
        });
    }
});

app.post('/api/users', async (req, res) => {
    try {
        const { name, email, age } = req.body;

        if (!name || !email) {
            return res.status(400).json({
                success: false,
                error: 'Name and email are required'
            });
        }

        const { rows } = await pool.query(
            'INSERT INTO users (name, email, age) VALUES ($1, $2, $3) RETURNING *',
            [name, email, age]
        );

        res.status(201).json({
            success: true,
            data: rows[0]
        });
    } catch (error) {
        console.error('Error creating user:', error);

        if (error.code === '23505') { // Unique violation
            return res.status(409).json({
                success: false,
                error: 'Email already exists'
            });
        }

        res.status(500).json({
            success: false,
            error: 'Failed to create user'
        });
    }
});

app.put('/api/users/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const { name, email, age } = req.body;

        const { rows } = await pool.query(
            'UPDATE users SET name = $1, email = $2, age = $3, updated_at = CURRENT_TIMESTAMP WHERE id = $4 RETURNING *',
            [name, email, age, id]
        );

        if (rows.length === 0) {
            return res.status(404).json({
                success: false,
                error: 'User not found'
            });
        }

        res.json({
            success: true,
            data: rows[0]
        });
    } catch (error) {
        console.error('Error updating user:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to update user'
        });
    }
});

app.delete('/api/users/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const { rows } = await pool.query('DELETE FROM users WHERE id = $1 RETURNING *', [id]);

        if (rows.length === 0) {
            return res.status(404).json({
                success: false,
                error: 'User not found'
            });
        }

        res.json({
            success: true,
            data: rows[0]
        });
    } catch (error) {
        console.error('Error deleting user:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to delete user'
        });
    }
});

// Health check
app.get('/health', async (req, res) => {
    try {
        await pool.query('SELECT NOW()');
        res.json({
            status: 'OK',
            database: 'connected',
            timestamp: new Date()
        });
    } catch (error) {
        res.status(500).json({
            status: 'ERROR',
            database: 'disconnected',
            error: error.message
        });
    }
});

// Error handling middleware
app.use((error, req, res, next) => {
    console.error('Unhandled error:', error);
    res.status(500).json({
        success: false,
        error: 'Internal server error'
    });
});

// Graceful shutdown
process.on('SIGINT', async () => {
    console.log('Shutting down gracefully...');
    await pool.end();
    process.exit(0);
});

app.listen(port, () => {
    console.log(`Server running on port ${port}`);
});</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Express.js API with MongoDB/Mongoose</h3>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-6 mb-6">
                    <div class="bg-gray-200 px-4 py-2 rounded-t-lg font-semibold text-gray-700 mb-4">Express.js API with MongoDB/Mongoose</div>
                    <pre class="text-sm overflow-x-auto"><code>const express = require('express');
const mongoose = require('mongoose');
require('dotenv').config();

const app = express();
const port = process.env.PORT || 3000;

// Middleware
app.use(express.json());

// Connect to MongoDB
mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/myapp', {
    useNewUrlParser: true,
    useUnifiedTopology: true
})
.then(() => console.log('Connected to MongoDB'))
.catch(error => {
    console.error('MongoDB connection error:', error);
    process.exit(1);
});

// User Schema
const userSchema = new mongoose.Schema({
    name: { type: String, required: true },
    email: { type: String, required: true, unique: true },
    age: { type: Number, min: 0 },
    role: { type: String, enum: ['user', 'admin'], default: 'user' },
    isActive: { type: Boolean, default: true }
}, { timestamps: true });

const User = mongoose.model('User', userSchema);

// Routes
app.get('/api/users', async (req, res) => {
    try {
        const { page = 1, limit = 10, role, isActive } = req.query;

        const filter = {};
        if (role) filter.role = role;
        if (isActive !== undefined) filter.isActive = isActive === 'true';

        const users = await User.find(filter)
            .limit(limit * 1)
            .skip((page - 1) * limit)
            .sort({ createdAt: -1 });

        const total = await User.countDocuments(filter);

        res.json({
            success: true,
            data: users,
            pagination: {
                currentPage: parseInt(page),
                totalPages: Math.ceil(total / limit),
                totalUsers: total,
                hasNext: page * limit < total,
                hasPrev: page > 1
            }
        });
    } catch (error) {
        console.error('Error fetching users:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to fetch users'
        });
    }
});

app.get('/api/users/:id', async (req, res) => {
    try {
        const user = await User.findById(req.params.id);

        if (!user) {
            return res.status(404).json({
                success: false,
                error: 'User not found'
            });
        }

        res.json({
            success: true,
            data: user
        });
    } catch (error) {
        console.error('Error fetching user:', error);

        if (error.name === 'CastError') {
            return res.status(400).json({
                success: false,
                error: 'Invalid user ID'
            });
        }

        res.status(500).json({
            success: false,
            error: 'Failed to fetch user'
        });
    }
});

app.post('/api/users', async (req, res) => {
    try {
        const { name, email, age, role } = req.body;

        const user = new User({
            name,
            email,
            age,
            role
        });

        const savedUser = await user.save();

        res.status(201).json({
            success: true,
            data: savedUser
        });
    } catch (error) {
        console.error('Error creating user:', error);

        if (error.name === 'ValidationError') {
            return res.status(400).json({
                success: false,
                error: error.message
            });
        }

        if (error.code === 11000) { // Duplicate key error
            return res.status(409).json({
                success: false,
                error: 'Email already exists'
            });
        }

        res.status(500).json({
            success: false,
            error: 'Failed to create user'
        });
    }
});

app.put('/api/users/:id', async (req, res) => {
    try {
        const { name, email, age, role, isActive } = req.body;

        const user = await User.findByIdAndUpdate(
            req.params.id,
            { name, email, age, role, isActive },
            { new: true, runValidators: true }
        );

        if (!user) {
            return res.status(404).json({
                success: false,
                error: 'User not found'
            });
        }

        res.json({
            success: true,
            data: user
        });
    } catch (error) {
        console.error('Error updating user:', error);

        if (error.name === 'ValidationError') {
            return res.status(400).json({
                success: false,
                error: error.message
            });
        }

        res.status(500).json({
            success: false,
            error: 'Failed to update user'
        });
    }
});

app.delete('/api/users/:id', async (req, res) => {
    try {
        const user = await User.findByIdAndDelete(req.params.id);

        if (!user) {
            return res.status(404).json({
                success: false,
                error: 'User not found'
            });
        }

        res.json({
            success: true,
            data: user
        });
    } catch (error) {
        console.error('Error deleting user:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to delete user'
        });
    }
});

// Health check
app.get('/health', async (req, res) => {
    try {
        await mongoose.connection.db.admin().ping();
        res.json({
            status: 'OK',
            database: 'connected',
            timestamp: new Date()
        });
    } catch (error) {
        res.status(500).json({
            status: 'ERROR',
            database: 'disconnected',
            error: error.message
        });
    }
});

app.listen(port, () => {
    console.log(`Server running on port ${port}`);
});</code></pre>
                </div>
            </section>

            <!-- Practice Exercise -->
            <section class="mb-12">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
                    <h4 class="text-xl font-semibold text-blue-800 mb-4">üõ†Ô∏è Practice Exercise: Build a Blog API</h4>
                    <p class="text-gray-700 mb-4">Create a complete blog API with the following features:</p>
                    <ul class="list-disc list-inside text-gray-700 mb-4 space-y-2">
                        <li><strong>Posts Management:</strong> CRUD operations for blog posts</li>
                        <li><strong>Categories:</strong> Organize posts by categories</li>
                        <li><strong>Comments:</strong> Add comments to posts</li>
                        <li><strong>Authors:</strong> User management for blog authors</li>
                        <li><strong>Search & Filter:</strong> Search posts by title, category, or author</li>
                        <li><strong>Pagination:</strong> Implement pagination for large datasets</li>
                    </ul>
                    <p class="text-gray-700 mb-4"><strong>Requirements:</strong></p>
                    <ul class="list-disc list-inside text-gray-700 space-y-2">
                        <li>Choose either PostgreSQL or MongoDB/Mongoose</li>
                        <li>Implement proper error handling and validation</li>
                        <li>Add authentication middleware (for future chapters)</li>
                        <li>Include comprehensive API documentation</li>
                        <li>Implement database relationships/associations</li>
                        <li>Add data seeding for testing</li>
                    </ul>
                </div>
            </section>

            <!-- Knowledge Check -->
            <section class="mb-12">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                    <h4 class="text-xl font-semibold text-yellow-800 mb-4">üìù Knowledge Check</h4>
                    <ol class="list-decimal list-inside text-gray-700 space-y-3">
                        <li>What are the main differences between SQL and NoSQL databases?</li>
                        <li>Explain the concept of connection pooling and why it's important.</li>
                        <li>What is an ODM (Object Data Modeling) library and how does Mongoose fit this role?</li>
                        <li>How do you handle database connection errors in a Node.js application?</li>
                        <li>What are database transactions and when should you use them?</li>
                        <li>Explain the difference between parameterized queries and string concatenation for SQL queries.</li>
                        <li>How do you implement pagination in database queries?</li>
                        <li>What are database indexes and when should you create them?</li>
                    </ol>
                </div>
            </section>

            <!-- Chapter Summary -->
            <section class="mb-12">
                <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6">üìö Chapter Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                            <h5 class="text-lg font-semibold text-blue-600 mb-3">üêò PostgreSQL Integration</h5>
                            <p class="text-gray-700">Powerful relational database with connection pooling, parameterized queries, and transaction support for structured data management.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500">
                            <h5 class="text-lg font-semibold text-green-600 mb-3">üçÉ MongoDB & Mongoose</h5>
                            <p class="text-gray-700">Flexible NoSQL document database with ODM library providing schema validation, middleware, and query building capabilities.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-purple-500">
                            <h5 class="text-lg font-semibold text-purple-600 mb-3">üîó Express.js Integration</h5>
                            <p class="text-gray-700">Complete API development with proper error handling, validation, pagination, and database connection management.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-500">
                            <h5 class="text-lg font-semibold text-red-600 mb-3">üõ°Ô∏è Data Validation</h5>
                            <p class="text-gray-700">Input validation, error handling, and data sanitization to ensure data integrity and application security.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-orange-500">
                            <h5 class="text-lg font-semibold text-orange-600 mb-3">‚ö° Performance Optimization</h5>
                            <p class="text-gray-700">Connection pooling, indexing strategies, and query optimization for scalable database operations.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-indigo-500">
                            <h5 class="text-lg font-semibold text-indigo-600 mb-3">üèóÔ∏è Database Design</h5>
                            <p class="text-gray-700">Proper schema design, relationships, and data modeling for efficient and maintainable database structures.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Next Chapter -->
            <section class="mb-12">
                <div class="bg-gradient-to-r from-yellow-100 to-orange-100 border-2 border-orange-300 rounded-xl p-8 text-center">
                    <h3 class="text-2xl font-semibold text-orange-800 mb-4">üéØ Ready for Chapter 4?</h3>
                    <p class="text-gray-700 mb-6">In the next chapter, we'll explore authentication and security, covering JWT tokens, password hashing, session management, and security best practices.</p>
                    <a href="nodejs4.html" class="inline-block bg-orange-500 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-orange-600 transition-colors">Continue to Chapter 4: Authentication & Security ‚Üí</a>
                </div>
            </section>
        </main>
    </div>
</body>
</html>